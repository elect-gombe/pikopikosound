#include <stdio.h>
#include <stdint.h>

#define T 128
#define ONKAI 128
#define LEN 512

const
uint32_t onkai[ONKAI]={798611,896410,949714,1006186,1066017,1129406,1196564,1267715,1343098,1422962,1507576,1597221,1692197,1792820,1899427,2012373,2132035,2258812,2393128,2535431,2686195,2845925,3015152,3194443,3384394,3585641,3798854,4024746,4264070,4517624,4786256,5070862,5372391,5691850,6030305,6388886,6768788,7171282,7597708,8049491,8528139,9035249,9572512,10141724,10744782,11383700,12060610,12777771,13537577,14342563,15195416,16098983,17056278,18070497,19145025,20283447,21489564,22767399,24121220,25555542,27075153,28685126,30390832,32197965,34112556,36140994,38290049,40566894,42979127,45534799,48242439,51111083,54150307,57370251,60781664,64395930,68225111,72281987,76580098,81133787,85958254,91069597,96484877,102222167,108300613,114740502,121563328,128791859,136450222,144563974,153160195,162267574,171916506,182139194,192969754,204444332,216601225,229481004,243126654,257583717,272900442,289127947,306320389,324535147,343833011,364278386,385939506,408888663,433202448,458962006,486253307,515167433,545800882,578255891,612640776,649070292,687666020,728556769,771879008,817777323,866404892,917924008,972506609,1030334861,1091601760,1156511778,1225281547,1298140579};

const signed char kukei[512]={
-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-127,-76,-36,-3,23,44,60,74,84,93,100,105,110,113,116,118,120,121,122,123,124,125,125,126,126,126,126,126,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,76,36,3,-23,-44,-60,-74,-84,-93,-100,-105,-110,-113,-116,-118,-120,-121,-122,-123,-124,-125
};


typedef struct{
  int time;
  int length;
  int pitch;
  int vero;
} onpu_t;

typedef struct{
  int on;
  uint32_t th;
  int len;
  int t;
  int pitch;
  int vero;
} channel_t;

channel_t ch[8];

onpu_t humen[]={
#include "humen.txt"
};

int makenote(int pitch,int len,int vero){
  int i;
  for(i=0;i<8;i++){
    if(!(ch[i].on))break;
  }
  if(i==8){
    fprintf(stderr,"over flow");
    return -1;
  }
  ch[i].on = 1;
  ch[i].th = 0;
  ch[i].t = 0;
  ch[i].pitch = pitch;
  ch[i].len = len;
  ch[i].vero = vero;
  return 0;
}

void process(channel_t *ch,uint8_t *buff){
  int i;
  int new;
  int val;
  
  if(!(ch->on))return;
  if(ch->t+T>ch->len){
    for(i=0;i<T;i++,ch->t++){
      if(ch->t>ch->len){
	if(ch->vero==0){
	  ch->on=0;
	  break;
	}ch->vero--;
      }
      new = (kukei[(ch->th>>32-9)]*ch->vero-ch->vero/2)>>9;
      buff[i] += new;
      ch->th += onkai[ch->pitch];
    }
  }else{
    for(i=0;i<T;i++,ch->t++){
      new = (kukei[(ch->th>>32-9)]*ch->vero-ch->vero/2)>>9;
      buff[i] += new;
      ch->th += onkai[ch->pitch];
    }
  }
}

int output(uint8_t *data,size_t len){
  size_t i;
  for(i=0;i<len;i++){
    printf("%c",data[i]);
  }
  return 0;
}

int main(void){
  uint8_t buff[T];
  int prev;
  size_t i,j=85000*40,k=0;
  while(1){
    if(humen[k].time < (int)(j/40)){
      if(humen[k].time == -1)return 0;
      makenote(humen[k].pitch-1,humen[k].length*40,humen[k].vero);
      k++;
    }
    j+=T;
    for(i=0;i<T;i++){buff[i]=127;}
    for(i=0;i<sizeof(ch)/sizeof(ch[0]);i++){
      process(&(ch[i]),buff);
    }
    for(i=0;i<T;i++){
      buff[i] = (buff[i]+prev)/2;
      prev = buff[i];
    }
    output(buff,T);
  }
  
  return 0;  
}
